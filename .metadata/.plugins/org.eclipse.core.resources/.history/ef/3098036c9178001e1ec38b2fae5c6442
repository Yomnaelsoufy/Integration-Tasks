package com.example.main.api.router;

import org.apache.camel.builder.RouteBuilder;
import org.springframework.stereotype.Component;

import com.example.main.api.processor.FirstApiResponseProcessor;
import com.example.main.api.processor.FirstServiceProcessor;

@Component
public class MyRestService extends RouteBuilder {

    @Override
    public void configure() throws Exception {
        restConfiguration().component("servlet");
        rest("/v1/consumers/id-verification/nafath-app/initiate").post().to("direct:firstService");

        from("direct:firstService").routeId("FirstServiceRoute")
                .log("My Service call Request: ${body}")
                .process(new FirstServiceProcessor())
                .toD("http://localhost:8085/v1/consumers/${header.consumerId}/id-verification/validate?bridgeEndpoint=true")
                .log("First Api call Response: ${body}")
                .process(new FirstApiResponseProcessor())
                .choice()
                .when(simple("${header.CamelHttpResponseCode} == 200 && ${header.ResponseStatusCode} == 'I000000'"))
                .choice()
                .when(simple("${header.isTahakookVerified} == false")).to("direct:secondService")
                .otherwise().to("direct:fourthService")
                .endChoice()
                .otherwise()
                .log("Failed to verify Customer ID")
                .endChoice();

        from("direct:secondService").routeId("SecondServiceRoute")
                .process(new SecondServiceProcessor())
                .to("http://localhost:7882/v1/tahaqoq/mobile-verification?bridgeEndpoint=true")
                .log("Second Service call Response ${body}")
                .process(new SecondApiResponseProcessor())
                .choice()
                .when(simple("${header.CamelHttpResponseCode} == 200 && ${header.ResponseStatusCode} == 'I000000' && ${header.isOwner} == true"))
                .to("direct:thirdService")
                .otherwise()
                .log("Failed to verify Tahqooq");

        from("direct:thirdService").routeId("ThirdServiceRoute")
                .to("http://localhost:8082/v1/consumers/mobile?bridgeEndpoint=true")
                .log("Third Service call Response ${body}")
                .process(new ThirdApiResponseProcessor())
                .choice()
                .when(simple("${header.CamelHttpResponseCode} == 200 && ${header.ResponseStatusCode} == 'I000000'"))
                .to("direct:fourthService")
                .otherwise()
                .log("Failed to Update mobile number");

        from("direct:fourthService").routeId("FourthServiceRoute")
                .to("http://localhost:8086/v1/nafath-app/id-verification/initiate?bridgeEndpoint=true");
    }
}
